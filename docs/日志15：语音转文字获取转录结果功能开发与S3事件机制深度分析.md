# æ—¥å¿—15ï¼šè¯­éŸ³è½¬æ–‡å­—è·å–è½¬å½•ç»“æœåŠŸèƒ½å¼€å‘ä¸S3äº‹ä»¶æœºåˆ¶æ·±åº¦åˆ†æ

**æ—¥æœŸ**: 2025å¹´7æœˆ7æ—¥  
**ä»»åŠ¡**: åœ¨è¯­éŸ³è½¬æ–‡å­—æµ‹è¯•é¡µé¢æ·»åŠ "è·å–è½¬å½•ç»“æœ"æŒ‰é’®ï¼Œå®ç°å®Œæ•´çš„è¯­éŸ³è½¬æ–‡å­—å·¥ä½œæµç¨‹

## ğŸ“‹ éœ€æ±‚åˆ†æ

### åŸå§‹éœ€æ±‚

åœ¨ `speech_to_text_test_page.dart` çš„æŒ‰é’®åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªã€è·å–è½¬å½•ç»“æœæŒ‰é’®ã€‘ï¼Œå®ç°ä»¥ä¸‹æµç¨‹ï¼š

1. ç”¨æˆ·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ°S3
2. S3äº‹ä»¶è§¦å‘Lambdaå‡½æ•°
3. Lambdaå‡½æ•°å¯åŠ¨AWS Transcribeè½¬å½•ä»»åŠ¡  
4. è½¬å½•å®Œæˆåç»“æœä¿å­˜åˆ°S3
5. ç”¨æˆ·ç‚¹å‡»"è·å–è½¬å½•ç»“æœ"æŒ‰é’®ä¸‹è½½å¹¶æ˜¾ç¤ºè½¬å½•å†…å®¹

### æŠ€æœ¯æŒ‘æˆ˜

- æ–‡ä»¶ååŒ¹é…é—®é¢˜ï¼ˆLambdaç”Ÿæˆçš„æ–‡ä»¶å vs Flutterä¸Šä¼ çš„æ–‡ä»¶åï¼‰
- è½¬å½•ä»»åŠ¡çŠ¶æ€æ£€æŸ¥æœºåˆ¶
- S3æƒé™é…ç½®éªŒè¯
- å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ çš„å¤„ç†ç­–ç•¥

## ğŸ”§ è§£å†³æ–¹æ¡ˆè®¾è®¡

### 1. æ–‡ä»¶ååŒ¹é…ç­–ç•¥

**é—®é¢˜**: Lambdaå‡½æ•°ç”Ÿæˆçš„è½¬å½•ç»“æœæ–‡ä»¶åæ ¼å¼æ˜¯`transcripts/${filename}-${timestamp}.json`ï¼Œè€ŒFlutterç«¯ä¸Šä¼ çš„æ–‡ä»¶åæ˜¯`test_audio_${timestamp}.mp3`

**è§£å†³æ–¹æ¡ˆ**: ç®€åŒ–Lambdaå‡½æ•°çš„æ–‡ä»¶åç”Ÿæˆï¼Œå»æ‰timestamp

- **ä¿®æ”¹å‰**: `transcripts/test_audio_1751880656765-1751880662506.json`
- **ä¿®æ”¹å**: `transcripts/test_audio_1751880656765.json`

### 2. è½¬å½•ä»»åŠ¡çŠ¶æ€æ£€æŸ¥

æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š

- **æ–¹æ¡ˆA**: ç›´æ¥å°è¯•ä¸‹è½½è½¬å½•ç»“æœæ–‡ä»¶ï¼ˆé‡‡ç”¨ï¼‰
- **æ–¹æ¡ˆB**: è°ƒç”¨AWS Transcribe APIæ£€æŸ¥ä»»åŠ¡çŠ¶æ€

**é€‰æ‹©æ–¹æ¡ˆAçš„åŸå› **:

- å®ç°æ›´ç®€å•
- å¦‚æœæ–‡ä»¶å­˜åœ¨è¯´æ˜ä»»åŠ¡å®Œæˆ
- é¿å…é¢å¤–çš„APIè°ƒç”¨

### 3. S3æƒé™éªŒè¯

é€šè¿‡AWS CLIæ£€æŸ¥äº†æƒé™é…ç½®ï¼š

```bash
aws iam get-role --role-name amplify-nirvaapp-dev-0e8a7-unauthRole
aws iam list-attached-role-policies --role-name amplify-nirvaapp-dev-0e8a7-unauthRole
```

**ç»“æœ**: æœªè®¤è¯ç”¨æˆ·è§’è‰²æ‹¥æœ‰`AmazonS3FullAccess`æƒé™ï¼Œæ»¡è¶³éœ€æ±‚ã€‚

## ğŸ’» ä»£ç å®ç°

### 1. Lambdaå‡½æ•°ä¿®æ”¹

**æ–‡ä»¶**: `/amplify/backend/function/S3Trigger0f8e56ad/src/index.js`

```javascript
// ä¿®æ”¹å‰
const outputKey = `transcripts/${filename}-${timestamp}.json`;

// ä¿®æ”¹å  
const outputKey = `transcripts/${filename}.json`;
```

### 2. Flutterç«¯çŠ¶æ€ç®¡ç†

**æ–‡ä»¶**: `lib/speech_to_text_test_page.dart`

```dart
// æ·»åŠ çŠ¶æ€å˜é‡
String? _lastUploadedFileName; // ä¿å­˜æœ€åä¸Šä¼ çš„æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰

// åœ¨ä¸Šä¼ æˆåŠŸåä¿å­˜æ–‡ä»¶å
_lastUploadedFileName = fileName.substring(0, fileName.lastIndexOf('.'));
```

### 3. è·å–è½¬å½•ç»“æœæ–¹æ³•

```dart
Future<void> _getTranscriptionResult() async {
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ è®°å½•
  // 2. æ„é€ è½¬å½•ç»“æœæ–‡ä»¶è·¯å¾„
  // 3. ä»S3ä¸‹è½½è½¬å½•ç»“æœ
  // 4. è§£æJSONå¹¶æå–è½¬å½•æ–‡æœ¬
  // 5. ç¾åŒ–æ˜¾ç¤ºç»“æœ
}
```

### 4. UIæŒ‰é’®è®¾è®¡

- **ç»¿è‰²**: API Gatewayæµ‹è¯• (Icons.health_and_safety)
- **æ©™è‰²**: ä¸Šä¼ éŸ³é¢‘åˆ°S3 (Icons.upload_file)  
- **ç´«è‰²**: è·å–è½¬å½•ç»“æœ (Icons.download)

## ğŸ” S3äº‹ä»¶æœºåˆ¶æ·±åº¦åˆ†æ

### åˆ†ç‰‡ä¸Šä¼ è¯¯åŒºæ¾„æ¸…

**åˆå§‹é”™è¯¯ç†è§£**: è®¤ä¸ºå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ä¼šè§¦å‘å¤šä¸ªS3äº‹ä»¶ï¼Œæ¯ä¸ªåˆ†ç‰‡ä¸€ä¸ªäº‹ä»¶

**æ­£ç¡®ç†è§£**:

- åˆ†ç‰‡ä¸Šä¼ è¿‡ç¨‹ä¸­ï¼ŒS3 **ä¸ä¼š** ä¸ºæ¯ä¸ªåˆ†ç‰‡è§¦å‘äº‹ä»¶
- åªæœ‰åœ¨ **å®Œæ•´çš„åˆ†ç‰‡ä¸Šä¼ å®Œæˆå**ï¼ŒS3æ‰ä¼šè§¦å‘ **ä¸€æ¬¡** `s3:ObjectCreated:CompleteMultipartUpload` äº‹ä»¶

### Lambdaäº‹ä»¶æ‰¹å¤„ç†æœºåˆ¶

**å•ä¸ªeventåŒ…å«å¤šä¸ªrecordsçš„åœºæ™¯**:

1. **åŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶**

```javascript
{
  "Records": [
    {"eventName": "s3:ObjectCreated:Put", "s3": {"object": {"key": "file1.mp3"}}},
    {"eventName": "s3:ObjectCreated:Put", "s3": {"object": {"key": "file2.mp3"}}},
    {"eventName": "s3:ObjectCreated:Put", "s3": {"object": {"key": "file3.mp3"}}}
  ]
}
```

**æ‰¹é‡æ“ä½œ**ï¼ˆå¦‚ `aws s3 cp --recursive`ï¼‰

**æ··åˆS3äº‹ä»¶ç±»å‹**ï¼ˆåˆ›å»ºã€å¤åˆ¶ã€åˆ é™¤ç­‰ï¼‰

### Lambdaä»£ç ä¸­forå¾ªç¯çš„ä½œç”¨

```javascript
for (let i = 0; i < event.Records.length; i++) {
  // å¤„ç†æ¯ä¸ªç‹¬ç«‹çš„S3äº‹ä»¶
  // å¯èƒ½æ˜¯ä¸åŒçš„æ–‡ä»¶ï¼Œä¸åŒçš„æ“ä½œç±»å‹
}
```

- âœ… å¤„ç†åŒæ—¶ä¸Šä¼ çš„å¤šä¸ªä¸åŒæ–‡ä»¶
- âœ… å¤„ç†æ··åˆçš„S3äº‹ä»¶ç±»å‹  
- âœ… ç¡®ä¿æ¯ä¸ªS3äº‹ä»¶éƒ½å¾—åˆ°æ­£ç¡®å¤„ç†

## ğŸ“ æ–‡ä»¶å¤§å°é™åˆ¶ç­–ç•¥

### 99MBé™åˆ¶çš„è®¾è®¡è€ƒè™‘

```dart
const int maxFileSize = 99 * 1024 * 1024; // 99MB in bytes
```

**é™åˆ¶åŸå› **:

1. **ç®€åŒ–ç³»ç»Ÿå¤æ‚åº¦**: é¿å…åˆ†ç‰‡ä¸Šä¼ çš„é¢å¤–å¤„ç†é€»è¾‘
2. **è¦†ç›–ä¸»è¦åœºæ™¯**: ç»å¤§å¤šæ•°è¯­éŸ³æ–‡ä»¶ä¸ä¼šè¶…è¿‡99MB
3. **å¼€å‘æµ‹è¯•æœŸä¿å®ˆç­–ç•¥**: åç»­å¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´

**é”™è¯¯ä¿¡æ¯è®¾è®¡**:

- è¯¦ç»†è¯´æ˜è¶…é™åŸå› 
- æä¾›å…·ä½“è§£å†³æ–¹æ¡ˆï¼ˆffmpegå‹ç¼©ç­‰ï¼‰
- ç»™å‡ºæŠ€æœ¯èƒŒæ™¯è§£é‡Š

## ğŸ”¬ æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### å®Œæ•´æµ‹è¯•æµç¨‹

1. **ä¸Šä¼ éŸ³é¢‘** â†’ ç‚¹å‡»"ä¸Šä¼ éŸ³é¢‘åˆ°S3"æŒ‰é’®
2. **ç­‰å¾…è½¬å½•** â†’ ç­‰å¾…2-3åˆ†é’Ÿè®©AWS Transcribeå®Œæˆè½¬å½•
3. **è·å–ç»“æœ** â†’ ç‚¹å‡»"è·å–è½¬å½•ç»“æœ"æŒ‰é’®

### å¤šRecordsæµ‹è¯•æ–¹æ³•

```bash
# æ–¹æ³•1: AWS CLIå¿«é€Ÿè¿ç»­ä¸Šä¼ 
aws s3 cp audio1.mp3 s3://bucket/ &
aws s3 cp audio2.mp3 s3://bucket/ &
aws s3 cp audio3.mp3 s3://bucket/ &
wait

# æ–¹æ³•2: æ‰¹é‡ä¸Šä¼ è„šæœ¬
for i in {1..5}; do
  aws s3 cp test.mp3 s3://bucket/test_$i.mp3 &
done
wait
```

## ğŸ¯ å…³é”®å®ç°ç»†èŠ‚

### é”™è¯¯å¤„ç†æœºåˆ¶

```dart
// æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒå»ºè®®
if (e.toString().contains('NoSuchKey')) {
  // è½¬å½•ä»»åŠ¡å°šæœªå®Œæˆçš„å¤„ç†
} else if (e.toString().contains('AccessDenied')) {
  // æƒé™é—®é¢˜çš„å¤„ç†  
} else {
  // å…¶ä»–é”™è¯¯çš„é€šç”¨å¤„ç†
}
```

### JSONè§£æä¸æ˜¾ç¤º

```dart
// æå–è½¬å½•æ–‡æœ¬
String transcriptText = transcriptionData['results']['transcripts'][0]['transcript'];

// ç¾åŒ–JSONæ˜¾ç¤º
const JsonEncoder encoder = JsonEncoder.withIndent('  ');
final prettyJson = encoder.convert(transcriptionData);
```

## ğŸ“ˆ åç»­ä¼˜åŒ–æ–¹å‘

### 1. å¤§æ–‡ä»¶æ”¯æŒæ”¹è¿›

- å®ç°åˆ†ç‰‡ä¸Šä¼ å®Œæˆäº‹ä»¶æ£€æµ‹
- ä¼˜åŒ–Lambdaå‡½æ•°å¤„ç†åˆ†ç‰‡ä¸Šä¼ 
- æé«˜æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå¦‚500MBï¼‰

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- æ·»åŠ è½¬å½•è¿›åº¦æŸ¥è¯¢
- å®ç°è½¬å½•ä»»åŠ¡çŠ¶æ€å®æ—¶ç›‘æ§
- æ”¯æŒè½¬å½•ç»“æœçš„å†å²è®°å½•

### 3. é”™è¯¯å¤„ç†å¢å¼º

- æ›´è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- è½¬å½•å¤±è´¥çš„è¯¦ç»†è¯Šæ–­

## ğŸ“Š æŠ€æœ¯æ”¶è·ä¸æ€»ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

1. **AWS S3äº‹ä»¶æœºåˆ¶**: åˆ†ç‰‡ä¸Šä¼ åªè§¦å‘ä¸€æ¬¡å®Œæˆäº‹ä»¶
2. **Lambdaæ‰¹å¤„ç†**: å¤šä¸ªS3äº‹ä»¶å¯èƒ½æ‰“åŒ…æˆä¸€ä¸ªLambdaè°ƒç”¨
3. **Amplifyæƒé™ç®¡ç†**: æœªè®¤è¯ç”¨æˆ·è§’è‰²çš„S3è®¿é—®æƒé™é…ç½®
4. **æ–‡ä»¶ååŒ¹é…ç­–ç•¥**: ç®€åŒ–æœåŠ¡ç«¯æ–‡ä»¶åç”Ÿæˆé€»è¾‘

### è®¾è®¡æ¨¡å¼åº”ç”¨

1. **çŠ¶æ€ç®¡ç†**: ä¿å­˜ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯ç”¨äºåç»­åŒ¹é…
2. **é”™è¯¯åˆ†ç±»å¤„ç†**: æ ¹æ®é”™è¯¯ç±»å‹æä¾›é’ˆå¯¹æ€§è§£å†³æ–¹æ¡ˆ
3. **æ¸è¿›å¼å¢å¼º**: ä»ç®€å•é™åˆ¶å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–å¤æ‚åœºæ™¯

### æœ€ä½³å®è·µ

1. **æƒé™æœ€å°åŒ–åŸåˆ™**: è™½ç„¶æœ‰FullAccessï¼Œä½†å®é™…ä½¿ç”¨æ—¶åº”éµå¾ªæœ€å°æƒé™
2. **ç”¨æˆ·å‹å¥½æç¤º**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
3. **å¼€å‘é˜¶æ®µä¿å®ˆç­–ç•¥**: 99MBé™åˆ¶åœ¨å¼€å‘æµ‹è¯•æœŸæ˜¯åˆç†çš„

## ğŸ”„ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **åŠŸèƒ½æµ‹è¯•**: å®Œæ•´æµ‹è¯•è¯­éŸ³è½¬æ–‡å­—å·¥ä½œæµç¨‹
2. **æ€§èƒ½ç›‘æ§**: è§‚å¯ŸLambdaæ‰§è¡Œæ—¶é—´å’ŒTranscribeå“åº”é€Ÿåº¦
3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´UIå’Œé”™è¯¯æç¤º
4. **æ‰©å±•åŠŸèƒ½**: è€ƒè™‘æ·»åŠ éŸ³é¢‘æ ¼å¼è½¬æ¢ã€æ‰¹é‡å¤„ç†ç­‰åŠŸèƒ½

---
**å¤‡æ³¨**: æœ¬æ¬¡å¼€å‘åŠ æ·±äº†å¯¹AWS S3äº‹ä»¶æœºåˆ¶çš„ç†è§£ï¼Œçº æ­£äº†å¯¹åˆ†ç‰‡ä¸Šä¼ äº‹ä»¶è§¦å‘çš„é”™è¯¯è®¤çŸ¥ï¼Œä¸ºåç»­å¤§æ–‡ä»¶å¤„ç†å¥ å®šäº†ç†è®ºåŸºç¡€ã€‚
