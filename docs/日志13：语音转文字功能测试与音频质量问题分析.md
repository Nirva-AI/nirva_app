# 日志13：语音转文字功能测试与音频质量问题分析

**日期**: 2025年7月7日  
**作者**: GitHub Copilot  
**主题**: 语音转文字测试中音频质量影响分析

## 一、背景介绍

本次测试针对Nirva应用中的语音转文字功能，该功能通过以下流程实现：

1. 上传音频文件到AWS S3存储桶
2. S3事件触发Lambda函数
3. Lambda启动AWS Transcribe任务
4. 转录结果JSON存回S3

测试过程中发现，使用不同音频源进行测试时，AWS Transcribe返回结果存在明显差异：使用Mac合成的语音可以成功转录，而使用手机录制的语音转录结果为空。本文档旨在分析这一差异的原因。

## 二、问题描述

在执行`_testFileUploadAndTranscribe()`函数测试中，我们发现：

1. 使用`test_audio.mp3`(Mac say命令生成)：转录成功，得到识别文本
2. 使用`record_test_audio.mp3`(手机录制)：转录完成但结果为空字符串

这表明AWS Transcribe服务对音频质量有特定要求，需要进一步分析。

## 三、音频文件比较分析

### 3.1 音频文件基本信息对比

通过对两个音频文件的分析，我们发现以下差异：

| 特性 | 第一个文件（成功转录） | 第二个文件（转录为空） |
|------|------------------------|----------------------|
| 文件名 | test_audio.mp3（使用Mac say命令生成） | record_test_audio.mp3（手机录制） |
| 大小 | 174,332 字节（170KB） | 311,870 字节（305KB） |
| 采样率 | 22,050 Hz | 48,000 Hz |
| 比特率 | 128,339 bps | 121,871 bps |
| 时长 | 10.87秒 | 20.47秒 |
| 格式 | MP3 | MP3（来自M4A/Voice Memo） |
| 音量（平均） | **-18.9 dB** | **-34.6 dB** |
| 音量（最大） | **-3.3 dB** | **-10.7 dB** |

### 3.2 音频文件技术分析

```json
// 第一个音频文件（成功转录）音频元数据
{
    "format": {
        "filename": "assets/test_audio.mp3",
        "duration": "10.866939",
        "size": "174332",
        "bit_rate": "128339"
    },
    "streams": [{
        "sample_rate": "22050",
        "channels": 1,
        "channel_layout": "mono"
    }]
}

// 第二个音频文件（转录为空）音频元数据
{
    "format": {
        "filename": "assets/record_test_audio.mp3",
        "duration": "20.472000",
        "size": "311870",
        "bit_rate": "121871",
        "tags": {
            "major_brand": "M4A ",
            "minor_version": "0",
            "compatible_brands": "M4A isommp42",
            "voice-memo-uuid": "DD62B468-7E90-4811-A7B6-24D7B0D041E9"
        }
    },
    "streams": [{
        "sample_rate": "48000",
        "channels": 1,
        "channel_layout": "mono"
    }]
}
```

音量分析结果：

- 第一个文件平均音量：**-18.9 dB**，最大音量：**-3.3 dB**
- 第二个文件平均音量：**-34.6 dB**，最大音量：**-10.7 dB**

## 四、关键发现

通过对比分析，我们发现了以下关键差异，这很可能是导致第二个文件转录结果为空的原因：

### 4.1 音量差异

最显著的差异是音量水平：

- 第二个文件的平均音量比第一个文件低约15.7 dB
- 第二个文件的最大音量比第一个文件低约7.4 dB

这种差异对于语音识别服务来说是非常显著的。语音识别服务通常需要足够清晰的音频信号才能有效识别语音内容。

### 4.2 采样率差异

虽然第二个文件的采样率更高(48kHz vs 22kHz)，理论上应该提供更好的音质，但这一优势可能被过低的音量所抵消。

### 4.3 设备差异

第二个文件的元数据包含"voice-memo-uuid"标签，表明这是从iOS设备的语音备忘录录制的。手机麦克风的位置和环境噪声可能影响了录音质量。

## 五、解决方案建议

基于以上分析，我们提出以下解决方案建议：

### 5.1 短期解决方案

1. **音频预处理**：
   - 在上传前对音频进行归一化处理，提高音量
   - 可以使用FFmpeg或其他音频处理库在客户端进行处理
   - 推荐将音频平均音量提高至少15dB，使其达到-20dB左右

2. **音频格式标准化**：
   - 将所有音频统一为22050Hz采样率
   - 确保使用单声道(mono)格式

### 5.2 中长期解决方案

1. **改进用户体验**：
   - 添加录音音量反馈，在UI上显示音量水平
   - 提供录音指南，建议用户靠近麦克风或提高音量
   - 在录音界面添加音量可视化效果

2. **自动音频质量评估**：
   - 上传前自动检测音频质量，包括音量、信噪比等
   - 若质量不足，提供用户反馈和重录建议

3. **服务端处理优化**：
   - 在Lambda函数中添加音频预处理逻辑
   - 使用AWS Transcribe的自定义词汇表和上下文提示增强识别率

## 六、结论

本次测试确认，音频音量过低是导致AWS Transcribe转录失败的主要原因。虽然录音的技术参数（采样率、比特率等）符合要求，但信号强度不足使得转录服务无法有效识别语音内容。

通过实施上述建议，特别是在上传前进行音频音量增强处理，我们可以显著提高语音转文字的成功率，从而提升整体用户体验。

还有！注意LanguageCode的设置，目前的设置是 LanguageCode: 'en-US'。

## 七、后续行动项

1. 实现音频预处理模块，提高录音音量
2. 添加音频质量检测功能
3. 优化用户录音界面，提供实时音量反馈
4. 考虑使用更高级的语音识别服务或配置选项

---

*此日志文档由GitHub Copilot根据测试数据分析生成，旨在帮助开发团队理解并解决语音转文字功能中的音频质量问题。*
